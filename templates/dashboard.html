{% extends "base.html" %}

{% block title %}Dashboard - {{ username }} - Alpha Vantage Trading{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-2">
            <i class="fas fa-tachometer-alt me-2 text-primary"></i>
            HoÅŸ geldiniz, {{ username }}!
        </h1>
        <p class="text-muted mb-0">
            <i class="fas fa-robot me-1"></i>
            Son gÃ¼ncelleme: <span id="last-update">-</span>
            <span class="ms-3">
                <span class="badge bg-success" id="refresh-status">
                    <i class="fas fa-sync fa-spin me-1"></i>Otomatik (5dk)
                </span>
            </span>
        </p>
    </div>
    <div class="col-md-4 text-md-end">
        <div class="row g-2">
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('manage_watchlist') }}" class="btn btn-primary">
                        <i class="fas fa-heart me-1"></i>Watchlist
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Watchlist Status -->
{% if user_watchlist.forex or user_watchlist.stocks or user_watchlist.crypto %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Watchlist:</strong>
            {{ user_watchlist.forex|length }} Forex,
            {{ user_watchlist.stocks|length }} Hisse,
            {{ user_watchlist.crypto|length }} Crypto takip ediliyor.
            <a href="{{ url_for('manage_watchlist') }}" class="alert-link">DÃ¼zenle</a>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Watchlist boÅŸ!</strong>
            Ä°lgilendiÄŸiniz varlÄ±klarÄ± seÃ§mek iÃ§in watchlist oluÅŸturun.
            <a href="{{ url_for('manage_watchlist') }}" class="alert-link">Watchlist OluÅŸtur</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Daily Market Briefing -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>
                    GÃ¼nÃ¼n Piyasa Brifingi
                    <span class="badge bg-light text-primary ms-2" id="briefing-status">YÃ¼kleniyor...</span>
                </h5>
            </div>
            <div class="card-body" id="briefing-content">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">GÃ¼nÃ¼n analizi hazÄ±rlanÄ±yor...</p>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="fas fa-robot me-1"></i>
                    Worker tarafÄ±ndan saatlik gÃ¼ncellenir
                    <span class="badge bg-info ms-2">Otomatik</span>
                    <small class="float-end">Son: <span id="briefing-last-update">-</span></small>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Market Movers - Top Gainers & Losers -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-rocket me-2"></i>
                    Market Movers - En Ã‡ok YÃ¼kselenler & DÃ¼ÅŸenler
                    <span class="badge bg-light text-success ms-2" id="movers-status">YÃ¼kleniyor...</span>
                </h5>
            </div>
            <div class="card-body" id="market-movers-content">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Market movers yÃ¼kleniyor...</p>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="fas fa-robot me-1"></i>
                    Worker tarafÄ±ndan saatlik gÃ¼ncellenir  
                    <span class="badge bg-info ms-2">Otomatik</span>
                    <small class="float-end">Son: <span id="movers-last-update">-</span></small>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Live Data Display -->
<div id="live-data-container">
    <!-- Forex Section -->
    {% if user_watchlist.forex %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt me-2 text-primary"></i>
                        Forex Pairs
                        <span class="badge bg-primary">{{ user_watchlist.forex|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="forex-data">
                        <!-- Forex data will be loaded here -->
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Forex verileri yÃ¼kleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stocks Section -->
    {% if user_watchlist.stocks %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2 text-success"></i>
                        US Stocks
                        <span class="badge bg-success">{{ user_watchlist.stocks|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="stocks-data">
                        <!-- Stocks data will be loaded here -->
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Hisse verileri yÃ¼kleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Crypto Section -->
    {% if user_watchlist.crypto %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fab fa-bitcoin me-2 text-warning"></i>
                        Cryptocurrencies
                        <span class="badge bg-warning">{{ user_watchlist.crypto|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="crypto-data">
                        <!-- Crypto data will be loaded here -->
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Crypto verileri yÃ¼kleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- News Modal -->
<div class="modal fade" id="newsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-newspaper me-2"></i>
                    <span id="modal-symbol">-</span> Haberleri
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="news-content">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Haberler yÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Otomatik gÃ¼ncelleme iÃ§in interval deÄŸiÅŸkenleri (aÅŸaÄŸÄ±da tanÄ±mlÄ±)

// Load live data on page load - DISABLED to prevent Railway worker timeout
document.addEventListener('DOMContentLoaded', function() {
    // loadLiveData(); // Disabled - Use manual refresh instead
    console.log('ðŸ”´ Auto-load disabled - Click "Yenile" button to load data');
    
    // Refresh button
    document.getElementById('refresh-data').addEventListener('click', function() {
        loadLiveData();
    });
    
    // Refresh interval selector
    document.getElementById('refresh-interval').addEventListener('change', function() {
        const value = parseInt(this.value);
        
        if (value === 0) {
            // Manuel mode
            stopAutoRefresh();
            document.getElementById('start-auto-refresh').style.display = 'none';
            document.getElementById('stop-auto-refresh').style.display = 'none';
        } else {
            // Auto refresh mode - stop current if running
            if (isAutoRefreshActive) {
                stopAutoRefresh();
            }
            document.getElementById('start-auto-refresh').style.display = 'inline-block';
        }
    });
    
    // Start auto refresh
    document.getElementById('start-auto-refresh').addEventListener('click', function() {
        const interval = parseInt(document.getElementById('refresh-interval').value);
        if (interval > 0) {
            startAutoRefresh(interval);
        }
    });
    
    // Stop auto refresh
    document.getElementById('stop-auto-refresh').addEventListener('click', function() {
        stopAutoRefresh();
    });
});

// Load live data from API
async function loadLiveData() {
    try {
        showLoading(document.getElementById('live-data-container'));
        
        const response = await fetch('/api/live-data');
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Update each section
        updateForexData(data.forex || []);
        updateStocksData(data.stocks || []);
        updateCryptoData(data.crypto || []);
        
        // Update timestamp
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString('tr-TR');
        
        hideLoading(document.getElementById('live-data-container'));
        
    } catch (error) {
        console.error('Live data error:', error);
        showError('Veri yÃ¼klenirken hata oluÅŸtu: ' + error.message);
        hideLoading(document.getElementById('live-data-container'));
    }
}

// Update Forex data
function updateForexData(forexData) {
    const container = document.getElementById('forex-data');
    if (!container) return;
    
    if (forexData.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">Forex verisi bulunamadÄ±</p></div>';
        return;
    }
    
    let html = '';
    forexData.forEach(item => {
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card price-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">${item.symbol}</h6>
                            <small class="text-muted">
                                <i class="fas fa-chart-line me-1"></i>Teknik Analiz
                            </small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0">${formatPrice(item.price, item.symbol)}</span>
                            <span>${formatSignal(item.signal)}</span>
                        </div>
                    </div>
                </div>
            </div>`;
    });
    container.innerHTML = html;
}

// Update Stocks data
function updateStocksData(stocksData) {
    const container = document.getElementById('stocks-data');
    if (!container) return;
    
    if (stocksData.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">Hisse verisi bulunamadÄ±</p></div>';
        return;
    }
    
    let html = '';
    stocksData.forEach(item => {
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card price-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">${item.symbol}</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="showNews('${item.symbol}')" title="Haberler & Sentiment">
                                <i class="fas fa-newspaper me-1"></i>Haberler
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 mb-0">${formatPrice(item.price, item.symbol)}</span>
                            <span>${formatSignal(item.signal)}</span>
                        </div>
                        ${item.sentiment !== null ? `
                            <div class="mt-2">
                                <small class="text-muted">Sentiment:</small>
                                ${formatSentiment(item.sentiment)}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>`;
    });
    container.innerHTML = html;
}

// Update Crypto data
function updateCryptoData(cryptoData) {
    const container = document.getElementById('crypto-data');
    if (!container) return;
    
    if (cryptoData.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">Crypto verisi bulunamadÄ±</p></div>';
        return;
    }
    
    let html = '';
    cryptoData.forEach(item => {
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card price-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">${item.symbol}</h6>
                            <small class="text-muted">
                                <i class="fas fa-chart-bar me-1"></i>Teknik Analiz
                            </small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0">${formatPrice(item.price, item.symbol)}</span>
                            <span>${formatSignal(item.signal)}</span>
                        </div>
                    </div>
                </div>
            </div>`;
    });
    container.innerHTML = html;
}

// Show news modal
async function showNews(symbol) {
    const modal = new bootstrap.Modal(document.getElementById('newsModal'));
    document.getElementById('modal-symbol').textContent = symbol;
    document.getElementById('news-content').innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="mt-2 text-muted">Haberler yÃ¼kleniyor...</p>
        </div>`;
    
    modal.show();
    
    try {
        const response = await fetch(`/api/news/${symbol}`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        let html = `
            <div class="mb-3">
                <h6>Genel Sentiment: ${formatSentiment(data.overall_sentiment)}</h6>
                <p class="text-muted">Toplam ${data.news_count} haber analiz edildi</p>
            </div>`;
        
        if (data.top_news && data.top_news.length > 0) {
            html += '<h6>Son Haberler:</h6>';
            data.top_news.forEach(news => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <h6 class="card-title h6">${news.title}</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${formatAlphaVantageDate(news.time_published)}</small>
                                <small>Sentiment: ${formatSentiment(news.sentiment_score || news.overall_sentiment_score)}</small>
                            </div>
                        </div>
                    </div>`;
            });
        } else {
            html += '<p class="text-muted">Bu sembol iÃ§in haber bulunamadÄ±.</p>';
        }
        
        document.getElementById('news-content').innerHTML = html;
        
    } catch (error) {
        document.getElementById('news-content').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Haberler yÃ¼klenirken hata: ${error.message}
            </div>`;
    }
}

// Otomatik 5 dakikalÄ±k gÃ¼ncelleme sistemi
let autoRefreshInterval = null;
let briefingInterval = null;

function startFullAutoRefresh() {
    // Watchlist verilerini 5 dakikada bir gÃ¼ncelle
    autoRefreshInterval = setInterval(() => {
        console.log('ðŸ”„ Otomatik veri gÃ¼ncelleme (5dk)');
        loadLiveData();
        updateLastRefreshTime();
    }, 5 * 60 * 1000); // 5 dakika
    
    // Briefing ve Market Movers'Ä± 10 dakikada bir gÃ¼ncelle (cache'den hÄ±zlÄ±)
    briefingInterval = setInterval(() => {
        console.log('ðŸ“Š Otomatik briefing gÃ¼ncelleme (10dk)');
        loadDailyBriefing();
        loadMarketMovers();
    }, 10 * 60 * 1000); // 10 dakika
    
    console.log('âœ… Otomatik gÃ¼ncelleme sistemi aktif: Veri(5dk), Briefing(10dk)');
}

function updateLastRefreshTime() {
    document.getElementById('last-update').textContent = new Date().toLocaleString('tr-TR');
}

// Sayfa kapatÄ±lÄ±rken interval'larÄ± temizle
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    if (briefingInterval) clearInterval(briefingInterval);
});

// Daily Briefing Functions
async function loadDailyBriefing() {
    try {
        document.getElementById('briefing-status').textContent = 'YÃ¼kleniyor...';
        document.getElementById('briefing-status').className = 'badge bg-warning text-dark ms-2';
        
        const response = await fetch('/api/daily-briefing');
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Briefing yÃ¼klenemedi');
        }
        
        // Update content
        displayBriefingData(data);
        
        // Update status
        document.getElementById('briefing-status').textContent = 'GÃ¼ncel';
        document.getElementById('briefing-status').className = 'badge bg-success ms-2';
        
        // Update timestamp
        document.getElementById('briefing-last-update').textContent = new Date().toLocaleString('tr-TR');
        
    } catch (error) {
        console.error('Briefing error:', error);
        document.getElementById('briefing-content').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                GÃ¼nÃ¼n brifingi yÃ¼klenirken hata: ${error.message}
            </div>`;
        
        document.getElementById('briefing-status').textContent = 'Hata';
        document.getElementById('briefing-status').className = 'badge bg-danger ms-2';
    }
}

function displayBriefingData(data) {
    const sentiment = data.global_sentiment || {};
    const summary = data.market_summary || {};
    const opportunities = data.top_opportunities || [];
    const recommendations = data.recommendations || [];
    
    let html = `
        <div class="row">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="fas fa-globe me-1"></i>
                            Global Sentiment
                        </h6>
                        <h4 class="mb-0 ${getSentimentClass(sentiment.overall_score)}">
                            ${sentiment.status || 'Bilinmiyor'}
                        </h4>
                        <small class="text-muted">${sentiment.news_count || 0} haber analizi</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="fas fa-chart-line me-1"></i>
                            Sinyal Ã–zeti
                        </h6>
                        <div class="row">
                            <div class="col-6">
                                <span class="text-success fw-bold">${summary.buy_signals || 0}</span>
                                <br><small>ALIÅž</small>
                            </div>
                            <div class="col-6">
                                <span class="text-danger fw-bold">${summary.sell_signals || 0}</span>
                                <br><small>SATIÅž</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="fas fa-search me-1"></i>
                            Sistem TaramasÄ±
                        </h6>
                        <h4 class="mb-0 text-info">
                            ${summary.analyzed_symbols || 0}/${summary.total_symbols_in_system || 73}
                        </h4>
                        <small class="text-muted">${summary.opportunities_found || 0} fÄ±rsat bulundu</small>
                    </div>
                </div>
            </div>
        </div>`;
    
    // FÄ±rsatlar bÃ¶lÃ¼mÃ¼
    if (opportunities.length > 0) {
        html += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-star me-1"></i>GÃ¼nÃ¼n FÄ±rsatlarÄ±:</h6>
                    <div class="row">`;
        
        opportunities.forEach(opp => {
            const assetIcon = opp.asset_type === 'Stock' ? 'fas fa-chart-line' : 
                             opp.asset_type === 'Forex' ? 'fas fa-exchange-alt' : 
                             opp.asset_type === 'Crypto' ? 'fab fa-bitcoin' : 'fas fa-coins';
            
            html += `
                <div class="col-md-4 mb-2">
                    <div class="card border-${opp.signal === 'BUY' ? 'success' : 'danger'}">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${opp.symbol}</strong>
                                    <br><small class="text-muted">
                                        <i class="${assetIcon} me-1"></i>${opp.asset_type || 'Stock'}
                                    </small>
                                </div>
                                <span class="badge bg-${opp.signal === 'BUY' ? 'success' : 'danger'}">
                                    ${opp.signal}
                                </span>
                            </div>
                            <small class="text-muted">$${opp.price?.toFixed(2) || 'N/A'}</small>
                        </div>
                    </div>
                </div>`;
        });
        
        html += `
                    </div>
                </div>
            </div>`;
    }
    
    // Ã–neriler bÃ¶lÃ¼mÃ¼
    if (recommendations.length > 0) {
        html += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-lightbulb me-1"></i>GÃ¼nÃ¼n Ã–nerileri:</h6>
                    <ul class="list-unstyled">`;
        
        recommendations.forEach(rec => {
            html += `<li class="mb-1"><small>${rec}</small></li>`;
        });
        
        html += `
                    </ul>
                </div>
            </div>`;
    }
    
    document.getElementById('briefing-content').innerHTML = html;
}

function getSentimentClass(score) {
    if (score > 0.1) return 'text-success';
    if (score < -0.1) return 'text-danger';
    return 'text-warning';
}

// Market Movers Functions
async function loadMarketMovers() {
    try {
        document.getElementById('movers-status').textContent = 'YÃ¼kleniyor...';
        document.getElementById('movers-status').className = 'badge bg-warning text-dark ms-2';
        
        const response = await fetch('/api/market-movers');
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Market movers yÃ¼klenemedi');
        }
        
        // Update content
        displayMarketMovers(data);
        
        // Update status
        document.getElementById('movers-status').textContent = 'GÃ¼ncel';
        document.getElementById('movers-status').className = 'badge bg-success ms-2';
        
        // Update timestamp
        document.getElementById('movers-last-update').textContent = new Date().toLocaleString('tr-TR');
        
    } catch (error) {
        console.error('Market movers error:', error);
        document.getElementById('market-movers-content').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Market movers yÃ¼klenirken hata: ${error.message}
            </div>`;
        
        document.getElementById('movers-status').textContent = 'Hata';
        document.getElementById('movers-status').className = 'badge bg-danger ms-2';
    }
}

function displayMarketMovers(data) {
    const topGainers = data.top_gainers || [];
    const topLosers = data.top_losers || [];
    const mostActive = data.most_actively_traded || [];
    
    let html = `
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-success">
                    <i class="fas fa-arrow-up me-1"></i>
                    En Ã‡ok YÃ¼kselenler
                </h6>
                <div class="list-group list-group-flush">`;
    
    topGainers.slice(0, 5).forEach(stock => {
        const changePercent = parseFloat(stock.change_percentage?.replace('%', '') || 0);
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <div>
                    <strong>${stock.ticker}</strong>
                    <br><small class="text-muted">$${parseFloat(stock.price || 0).toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-success">+${changePercent.toFixed(2)}%</span>
                    <br><small class="text-success">+$${parseFloat(stock.change_amount || 0).toFixed(2)}</small>
                </div>
            </div>`;
    });
    
    html += `
                </div>
            </div>
            <div class="col-md-4">
                <h6 class="text-danger">
                    <i class="fas fa-arrow-down me-1"></i>
                    En Ã‡ok DÃ¼ÅŸenler
                </h6>
                <div class="list-group list-group-flush">`;
    
    topLosers.slice(0, 5).forEach(stock => {
        const changePercent = parseFloat(stock.change_percentage?.replace('%', '') || 0);
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <div>
                    <strong>${stock.ticker}</strong>
                    <br><small class="text-muted">$${parseFloat(stock.price || 0).toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-danger">${changePercent.toFixed(2)}%</span>
                    <br><small class="text-danger">$${parseFloat(stock.change_amount || 0).toFixed(2)}</small>
                </div>
            </div>`;
    });
    
    html += `
                </div>
            </div>
            <div class="col-md-4">
                <h6 class="text-primary">
                    <i class="fas fa-fire me-1"></i>
                    En Aktif Ä°ÅŸlem GÃ¶renler
                </h6>
                <div class="list-group list-group-flush">`;
    
    mostActive.slice(0, 5).forEach(stock => {
        const changePercent = parseFloat(stock.change_percentage?.replace('%', '') || 0);
        const isPositive = changePercent >= 0;
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <div>
                    <strong>${stock.ticker}</strong>
                    <br><small class="text-muted">$${parseFloat(stock.price || 0).toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-${isPositive ? 'success' : 'danger'}">
                        ${isPositive ? '+' : ''}${changePercent.toFixed(2)}%
                    </span>
                    <br><small class="text-muted">Vol: ${formatVolume(stock.volume)}</small>
                </div>
            </div>`;
    });
    
    html += `
                </div>
            </div>
        </div>`;
    
    document.getElementById('market-movers-content').innerHTML = html;
}

function formatVolume(volume) {
    const num = parseInt(volume || 0);
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

// Sayfa yÃ¼klendiÄŸinde otomatik sistem baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Dashboard yÃ¼kleniyor - Tam otomatik mod');
    
    // Ä°lk yÃ¼kleme - TÃ¼m verileri getir
    loadDailyBriefing();
    loadMarketMovers();
    loadLiveData();
    updateLastRefreshTime();
    
    // Otomatik gÃ¼ncelleme sistemini baÅŸlat
    startFullAutoRefresh();
    
    console.log('âœ… Dashboard tam otomatik modda Ã§alÄ±ÅŸÄ±yor');
    console.log('   ðŸ“Š Briefing/Market Movers: Cache\'den anÄ±nda');
    console.log('   ðŸ”„ Watchlist verileri: 5 dakikada bir');
    console.log('   ðŸ“ˆ Briefing gÃ¼ncellemesi: 10 dakikada bir');
});
</script>
{% endblock %} 