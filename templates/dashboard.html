{% extends "base.html" %}

{% block title %}Dashboard - {{ username }} - Alpha Vantage Trading{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-2">
            <i class="fas fa-tachometer-alt me-2 text-primary"></i>
            Ho≈ü geldiniz, {{ username }}!
        </h1>
        <p class="text-muted mb-0">
            <i class="fas fa-clock me-1"></i>
            Son g√ºncelleme: <span id="last-update">-</span>
            <span class="ms-3">
                <span class="badge bg-secondary" id="refresh-status">Manuel Mod</span>
            </span>
        </p>
    </div>
    <div class="col-md-4 text-md-end">
        <div class="row g-2">
            <div class="col-auto">
                <select class="form-select form-select-sm" id="refresh-interval">
                    <option value="0">Manuel</option>
                    <option value="30">30 saniye</option>
                    <option value="60">1 dakika</option>
                    <option value="120">2 dakika</option>
                    <option value="300">5 dakika</option>
                </select>
            </div>
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-success" id="start-auto-refresh" style="display: none;">
                        <i class="fas fa-play me-1"></i>Ba≈ülat
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="stop-auto-refresh" style="display: none;">
                        <i class="fas fa-stop me-1"></i>Durdur
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="refresh-data">
                        <i class="fas fa-sync-alt me-1"></i>Yenile
                    </button>
                    <a href="{{ url_for('manage_watchlist') }}" class="btn btn-primary">
                        <i class="fas fa-heart me-1"></i>Watchlist
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Watchlist Status -->
{% if user_watchlist.forex or user_watchlist.stocks or user_watchlist.crypto %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Watchlist:</strong>
            {{ user_watchlist.forex|length }} Forex,
            {{ user_watchlist.stocks|length }} Hisse,
            {{ user_watchlist.crypto|length }} Crypto takip ediliyor.
            <a href="{{ url_for('manage_watchlist') }}" class="alert-link">D√ºzenle</a>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Watchlist bo≈ü!</strong>
            ƒ∞lgilendiƒüiniz varlƒ±klarƒ± se√ßmek i√ßin watchlist olu≈üturun.
            <a href="{{ url_for('manage_watchlist') }}" class="alert-link">Watchlist Olu≈ütur</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Daily Market Briefing -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>
                    G√ºn√ºn Piyasa Brifingi
                    <span class="badge bg-light text-primary ms-2" id="briefing-status">Y√ºkleniyor...</span>
                </h5>
            </div>
            <div class="card-body" id="briefing-content">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">G√ºn√ºn analizi hazƒ±rlanƒ±yor...</p>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="fas fa-clock me-1"></i>
                    Son g√ºncelleme: <span id="briefing-last-update">-</span>
                    <button class="btn btn-outline-primary btn-sm float-end" id="refresh-briefing">
                        <i class="fas fa-sync me-1"></i>Yenile
                    </button>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Market Movers - Top Gainers & Losers -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-rocket me-2"></i>
                    Market Movers - En √áok Y√ºkselenler & D√º≈üenler
                    <span class="badge bg-light text-success ms-2" id="movers-status">Y√ºkleniyor...</span>
                </h5>
            </div>
            <div class="card-body" id="market-movers-content">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Market movers y√ºkleniyor...</p>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="fas fa-clock me-1"></i>
                    Son g√ºncelleme: <span id="movers-last-update">-</span>
                    <button class="btn btn-outline-success btn-sm float-end" id="refresh-movers">
                        <i class="fas fa-sync me-1"></i>Yenile
                    </button>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Live Data Display -->
<div id="live-data-container">
    <!-- Forex Section -->
    {% if user_watchlist.forex %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt me-2 text-primary"></i>
                        Forex Pairs
                        <span class="badge bg-primary">{{ user_watchlist.forex|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="forex-data">
                        <!-- Forex data will be loaded here -->
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Forex verileri y√ºkleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stocks Section -->
    {% if user_watchlist.stocks %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2 text-success"></i>
                        US Stocks
                        <span class="badge bg-success">{{ user_watchlist.stocks|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="stocks-data">
                        <!-- Stocks data will be loaded here -->
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Hisse verileri y√ºkleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Crypto Section -->
    {% if user_watchlist.crypto %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fab fa-bitcoin me-2 text-warning"></i>
                        Cryptocurrencies
                        <span class="badge bg-warning">{{ user_watchlist.crypto|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="crypto-data">
                        <!-- Crypto data will be loaded here -->
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Crypto verileri y√ºkleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- News Modal -->
<div class="modal fade" id="newsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-newspaper me-2"></i>
                    <span id="modal-symbol">-</span> Haberleri
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="news-content">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Haberler y√ºkleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let refreshInterval;
let isAutoRefreshActive = false;

// Load live data on page load - DISABLED to prevent Railway worker timeout
document.addEventListener('DOMContentLoaded', function() {
    // loadLiveData(); // Disabled - Use manual refresh instead
    console.log('üî¥ Auto-load disabled - Click "Yenile" button to load data');
    
    // Refresh button
    document.getElementById('refresh-data').addEventListener('click', function() {
        loadLiveData();
    });
    
    // Refresh interval selector
    document.getElementById('refresh-interval').addEventListener('change', function() {
        const value = parseInt(this.value);
        
        if (value === 0) {
            // Manuel mode
            stopAutoRefresh();
            document.getElementById('start-auto-refresh').style.display = 'none';
            document.getElementById('stop-auto-refresh').style.display = 'none';
        } else {
            // Auto refresh mode - stop current if running
            if (isAutoRefreshActive) {
                stopAutoRefresh();
            }
            document.getElementById('start-auto-refresh').style.display = 'inline-block';
        }
    });
    
    // Start auto refresh
    document.getElementById('start-auto-refresh').addEventListener('click', function() {
        const interval = parseInt(document.getElementById('refresh-interval').value);
        if (interval > 0) {
            startAutoRefresh(interval);
        }
    });
    
    // Stop auto refresh
    document.getElementById('stop-auto-refresh').addEventListener('click', function() {
        stopAutoRefresh();
    });
});

// Load live data from API
async function loadLiveData() {
    try {
        showLoading(document.getElementById('live-data-container'));
        
        const response = await fetch('/api/live-data');
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Update each section
        updateForexData(data.forex || []);
        updateStocksData(data.stocks || []);
        updateCryptoData(data.crypto || []);
        
        // Update timestamp
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString('tr-TR');
        
        hideLoading(document.getElementById('live-data-container'));
        
    } catch (error) {
        console.error('Live data error:', error);
        showError('Veri y√ºklenirken hata olu≈ütu: ' + error.message);
        hideLoading(document.getElementById('live-data-container'));
    }
}

// Update Forex data
function updateForexData(forexData) {
    const container = document.getElementById('forex-data');
    if (!container) return;
    
    if (forexData.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">Forex verisi bulunamadƒ±</p></div>';
        return;
    }
    
    let html = '';
    forexData.forEach(item => {
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card price-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">${item.symbol}</h6>
                            <small class="text-muted">
                                <i class="fas fa-chart-line me-1"></i>Teknik Analiz
                            </small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0">${formatPrice(item.price, item.symbol)}</span>
                            <span>${formatSignal(item.signal)}</span>
                        </div>
                    </div>
                </div>
            </div>`;
    });
    container.innerHTML = html;
}

// Update Stocks data
function updateStocksData(stocksData) {
    const container = document.getElementById('stocks-data');
    if (!container) return;
    
    if (stocksData.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">Hisse verisi bulunamadƒ±</p></div>';
        return;
    }
    
    let html = '';
    stocksData.forEach(item => {
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card price-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">${item.symbol}</h6>
                            <button class="btn btn-sm btn-outline-success" onclick="showNews('${item.symbol}')" title="Haberler & Sentiment">
                                <i class="fas fa-newspaper me-1"></i>Haberler
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 mb-0">${formatPrice(item.price, item.symbol)}</span>
                            <span>${formatSignal(item.signal)}</span>
                        </div>
                        ${item.sentiment !== null ? `
                            <div class="mt-2">
                                <small class="text-muted">Sentiment:</small>
                                ${formatSentiment(item.sentiment)}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>`;
    });
    container.innerHTML = html;
}

// Update Crypto data
function updateCryptoData(cryptoData) {
    const container = document.getElementById('crypto-data');
    if (!container) return;
    
    if (cryptoData.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">Crypto verisi bulunamadƒ±</p></div>';
        return;
    }
    
    let html = '';
    cryptoData.forEach(item => {
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card price-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">${item.symbol}</h6>
                            <small class="text-muted">
                                <i class="fas fa-chart-bar me-1"></i>Teknik Analiz
                            </small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0">${formatPrice(item.price, item.symbol)}</span>
                            <span>${formatSignal(item.signal)}</span>
                        </div>
                    </div>
                </div>
            </div>`;
    });
    container.innerHTML = html;
}

// Show news modal
async function showNews(symbol) {
    const modal = new bootstrap.Modal(document.getElementById('newsModal'));
    document.getElementById('modal-symbol').textContent = symbol;
    document.getElementById('news-content').innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="mt-2 text-muted">Haberler y√ºkleniyor...</p>
        </div>`;
    
    modal.show();
    
    try {
        const response = await fetch(`/api/news/${symbol}`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        let html = `
            <div class="mb-3">
                <h6>Genel Sentiment: ${formatSentiment(data.overall_sentiment)}</h6>
                <p class="text-muted">Toplam ${data.news_count} haber analiz edildi</p>
            </div>`;
        
        if (data.top_news && data.top_news.length > 0) {
            html += '<h6>Son Haberler:</h6>';
            data.top_news.forEach(news => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <h6 class="card-title h6">${news.title}</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${formatAlphaVantageDate(news.time_published)}</small>
                                <small>Sentiment: ${formatSentiment(news.sentiment_score || news.overall_sentiment_score)}</small>
                            </div>
                        </div>
                    </div>`;
            });
        } else {
            html += '<p class="text-muted">Bu sembol i√ßin haber bulunamadƒ±.</p>';
        }
        
        document.getElementById('news-content').innerHTML = html;
        
    } catch (error) {
        document.getElementById('news-content').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Haberler y√ºklenirken hata: ${error.message}
            </div>`;
    }
}

// Auto refresh with custom interval
function startAutoRefresh(intervalSeconds = 60) {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    
    isAutoRefreshActive = true;
    
    refreshInterval = setInterval(() => {
        loadLiveData();
    }, intervalSeconds * 1000);
    
    // Update UI
    document.getElementById('start-auto-refresh').style.display = 'none';
    document.getElementById('stop-auto-refresh').style.display = 'inline-block';
    
    // Update button states
    document.getElementById('start-auto-refresh').innerHTML = '<i class="fas fa-play me-1"></i>Ba≈ülat';
    document.getElementById('stop-auto-refresh').innerHTML = `<i class="fas fa-stop me-1"></i>Durdur (${intervalSeconds}s)`;
    
    // Update status
    document.getElementById('refresh-status').className = 'badge bg-success';
    document.getElementById('refresh-status').innerHTML = `<i class="fas fa-sync fa-spin me-1"></i>Otomatik (${intervalSeconds}s)`;
}

// Stop auto refresh
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    
    isAutoRefreshActive = false;
    
    // Update UI
    const intervalSelect = document.getElementById('refresh-interval');
    if (intervalSelect.value !== '0') {
        document.getElementById('start-auto-refresh').style.display = 'inline-block';
    }
    document.getElementById('stop-auto-refresh').style.display = 'none';
    
    // Update status
    document.getElementById('refresh-status').className = 'badge bg-secondary';
    document.getElementById('refresh-status').innerHTML = 'Manuel Mod';
}

// Show error message
function showError(message) {
    const alert = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alert);
}

// Clear interval on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// Daily Briefing Functions
async function loadDailyBriefing() {
    try {
        document.getElementById('briefing-status').textContent = 'Y√ºkleniyor...';
        document.getElementById('briefing-status').className = 'badge bg-warning text-dark ms-2';
        
        const response = await fetch('/api/daily-briefing');
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Briefing y√ºklenemedi');
        }
        
        // Update content
        displayBriefingData(data);
        
        // Update status
        document.getElementById('briefing-status').textContent = 'G√ºncel';
        document.getElementById('briefing-status').className = 'badge bg-success ms-2';
        
        // Update timestamp
        document.getElementById('briefing-last-update').textContent = new Date().toLocaleString('tr-TR');
        
    } catch (error) {
        console.error('Briefing error:', error);
        document.getElementById('briefing-content').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                G√ºn√ºn brifingi y√ºklenirken hata: ${error.message}
            </div>`;
        
        document.getElementById('briefing-status').textContent = 'Hata';
        document.getElementById('briefing-status').className = 'badge bg-danger ms-2';
    }
}

function displayBriefingData(data) {
    const sentiment = data.global_sentiment || {};
    const summary = data.market_summary || {};
    const opportunities = data.top_opportunities || [];
    const recommendations = data.recommendations || [];
    
    let html = `
        <div class="row">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="fas fa-globe me-1"></i>
                            Global Sentiment
                        </h6>
                        <h4 class="mb-0 ${getSentimentClass(sentiment.overall_score)}">
                            ${sentiment.status || 'Bilinmiyor'}
                        </h4>
                        <small class="text-muted">${sentiment.news_count || 0} haber analizi</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="fas fa-chart-line me-1"></i>
                            Sinyal √ñzeti
                        </h6>
                        <div class="row">
                            <div class="col-6">
                                <span class="text-success fw-bold">${summary.buy_signals || 0}</span>
                                <br><small>ALI≈û</small>
                            </div>
                            <div class="col-6">
                                <span class="text-danger fw-bold">${summary.sell_signals || 0}</span>
                                <br><small>SATI≈û</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="fas fa-search me-1"></i>
                            Sistem Taramasƒ±
                        </h6>
                        <h4 class="mb-0 text-info">
                            ${summary.analyzed_symbols || 0}/${summary.total_symbols_in_system || 73}
                        </h4>
                        <small class="text-muted">${summary.opportunities_found || 0} fƒ±rsat bulundu</small>
                    </div>
                </div>
            </div>
        </div>`;
    
    // Fƒ±rsatlar b√∂l√ºm√º
    if (opportunities.length > 0) {
        html += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-star me-1"></i>G√ºn√ºn Fƒ±rsatlarƒ±:</h6>
                    <div class="row">`;
        
        opportunities.forEach(opp => {
            const assetIcon = opp.asset_type === 'Stock' ? 'fas fa-chart-line' : 
                             opp.asset_type === 'Forex' ? 'fas fa-exchange-alt' : 
                             opp.asset_type === 'Crypto' ? 'fab fa-bitcoin' : 'fas fa-coins';
            
            html += `
                <div class="col-md-4 mb-2">
                    <div class="card border-${opp.signal === 'BUY' ? 'success' : 'danger'}">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${opp.symbol}</strong>
                                    <br><small class="text-muted">
                                        <i class="${assetIcon} me-1"></i>${opp.asset_type || 'Stock'}
                                    </small>
                                </div>
                                <span class="badge bg-${opp.signal === 'BUY' ? 'success' : 'danger'}">
                                    ${opp.signal}
                                </span>
                            </div>
                            <small class="text-muted">$${opp.price?.toFixed(2) || 'N/A'}</small>
                        </div>
                    </div>
                </div>`;
        });
        
        html += `
                    </div>
                </div>
            </div>`;
    }
    
    // √ñneriler b√∂l√ºm√º
    if (recommendations.length > 0) {
        html += `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-lightbulb me-1"></i>G√ºn√ºn √ñnerileri:</h6>
                    <ul class="list-unstyled">`;
        
        recommendations.forEach(rec => {
            html += `<li class="mb-1"><small>${rec}</small></li>`;
        });
        
        html += `
                    </ul>
                </div>
            </div>`;
    }
    
    document.getElementById('briefing-content').innerHTML = html;
}

function getSentimentClass(score) {
    if (score > 0.1) return 'text-success';
    if (score < -0.1) return 'text-danger';
    return 'text-warning';
}

// Market Movers Functions
async function loadMarketMovers() {
    try {
        document.getElementById('movers-status').textContent = 'Y√ºkleniyor...';
        document.getElementById('movers-status').className = 'badge bg-warning text-dark ms-2';
        
        const response = await fetch('/api/market-movers');
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Market movers y√ºklenemedi');
        }
        
        // Update content
        displayMarketMovers(data);
        
        // Update status
        document.getElementById('movers-status').textContent = 'G√ºncel';
        document.getElementById('movers-status').className = 'badge bg-success ms-2';
        
        // Update timestamp
        document.getElementById('movers-last-update').textContent = new Date().toLocaleString('tr-TR');
        
    } catch (error) {
        console.error('Market movers error:', error);
        document.getElementById('market-movers-content').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Market movers y√ºklenirken hata: ${error.message}
            </div>`;
        
        document.getElementById('movers-status').textContent = 'Hata';
        document.getElementById('movers-status').className = 'badge bg-danger ms-2';
    }
}

function displayMarketMovers(data) {
    const topGainers = data.top_gainers || [];
    const topLosers = data.top_losers || [];
    const mostActive = data.most_actively_traded || [];
    
    let html = `
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-success">
                    <i class="fas fa-arrow-up me-1"></i>
                    En √áok Y√ºkselenler
                </h6>
                <div class="list-group list-group-flush">`;
    
    topGainers.slice(0, 5).forEach(stock => {
        const changePercent = parseFloat(stock.change_percentage?.replace('%', '') || 0);
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <div>
                    <strong>${stock.ticker}</strong>
                    <br><small class="text-muted">$${parseFloat(stock.price || 0).toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-success">+${changePercent.toFixed(2)}%</span>
                    <br><small class="text-success">+$${parseFloat(stock.change_amount || 0).toFixed(2)}</small>
                </div>
            </div>`;
    });
    
    html += `
                </div>
            </div>
            <div class="col-md-4">
                <h6 class="text-danger">
                    <i class="fas fa-arrow-down me-1"></i>
                    En √áok D√º≈üenler
                </h6>
                <div class="list-group list-group-flush">`;
    
    topLosers.slice(0, 5).forEach(stock => {
        const changePercent = parseFloat(stock.change_percentage?.replace('%', '') || 0);
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <div>
                    <strong>${stock.ticker}</strong>
                    <br><small class="text-muted">$${parseFloat(stock.price || 0).toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-danger">${changePercent.toFixed(2)}%</span>
                    <br><small class="text-danger">$${parseFloat(stock.change_amount || 0).toFixed(2)}</small>
                </div>
            </div>`;
    });
    
    html += `
                </div>
            </div>
            <div class="col-md-4">
                <h6 class="text-primary">
                    <i class="fas fa-fire me-1"></i>
                    En Aktif ƒ∞≈ülem G√∂renler
                </h6>
                <div class="list-group list-group-flush">`;
    
    mostActive.slice(0, 5).forEach(stock => {
        const changePercent = parseFloat(stock.change_percentage?.replace('%', '') || 0);
        const isPositive = changePercent >= 0;
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <div>
                    <strong>${stock.ticker}</strong>
                    <br><small class="text-muted">$${parseFloat(stock.price || 0).toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-${isPositive ? 'success' : 'danger'}">
                        ${isPositive ? '+' : ''}${changePercent.toFixed(2)}%
                    </span>
                    <br><small class="text-muted">Vol: ${formatVolume(stock.volume)}</small>
                </div>
            </div>`;
    });
    
    html += `
                </div>
            </div>
        </div>`;
    
    document.getElementById('market-movers-content').innerHTML = html;
}

function formatVolume(volume) {
    const num = parseInt(volume || 0);
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

// Event listeners for briefing and market movers
document.addEventListener('DOMContentLoaded', function() {
    // Load briefing and market movers on page load
    loadDailyBriefing();
    loadMarketMovers();
    
    // Refresh briefing button
    document.getElementById('refresh-briefing').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Yenileniyor...';
        
        loadDailyBriefing().finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-sync me-1"></i>Yenile';
        });
    });
    
    // Refresh market movers button
    document.getElementById('refresh-movers').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Yenileniyor...';
        
        loadMarketMovers().finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-sync me-1"></i>Yenile';
        });
    });
});
</script>
{% endblock %} 